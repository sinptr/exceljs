{"version":3,"sources":["../../../../lib/stream/xlsx/worksheet-writer.js"],"names":["_","require","RelType","colCache","Dimensions","StringBuf","Row","Column","SheetRelsWriter","DataValidations","xmlBuffer","ListXform","DataValidationsXform","SheetPropertiesXform","SheetFormatPropertiesXform","ColXform","RowXform","HyperlinkXform","SheetViewXform","PageMarginsXform","HeaderFooterXform","PageSetupXform","AutoFilterXform","PictureXform","xform","dataValidations","sheetProperties","sheetFormatProperties","columns","tag","length","childXform","row","hyperlinks","sheetViews","pageMargins","headerFooter","pageSeteup","autoFilter","picture","WorksheetWriter","module","exports","options","id","name","state","_rows","_columns","_keys","_merges","add","_sheetRelsWriter","_dimensions","_rowZero","committed","_formulae","_siFormulae","properties","Object","assign","defaultRowHeight","dyDescent","outlineLevelCol","outlineLevelRow","pageSetup","margins","left","right","top","bottom","header","footer","orientation","horizontalDpi","verticalDpi","fitToPage","fitToWidth","fitToHeight","scale","pageOrder","blackAndWhite","draft","cellComments","errors","paperSize","undefined","showRowColHeaders","showGridLines","horizontalCentered","verticalCentered","rowBreaks","colBreaks","useSharedStrings","_workbook","workbook","_views","views","_writeOpenWorksheet","background","type","imageName","addMedia","pictureId","Target","Type","Image","_background","rId","startedData","prototype","stream","_stream","_openStream","pause","destroy","Error","commit","forEach","cRow","_writeRow","_writeOpenSheetData","_writeCloseSheetData","_writeAutoFilter","_writeMergeCells","_writeHyperlinks","_writeDataValidations","_writePageMargins","_writePageSetup","_writeHeaderFooter","_writeBackground","_writeCloseWorksheet","end","dimensions","value","_headerRowCount","reduce","pv","cv","headerCount","headers","Math","max","count","column","push","defn","getColumnKey","key","setColumnKey","deleteColumnKey","eachColumnKey","f","each","getColumn","c","col","l2n","n","_nextRow","eachRow","iteratee","includeEmpty","i","getRow","hasValues","number","_commitRow","found","shift","lastRow","findRow","rowNumber","index","addRow","values","findCell","r","address","getAddress","getCell","getCellEx","mergeCells","Array","slice","call","arguments","merge","intersects","master","j","_write","text","reset","addText","write","_writeSheetProperties","xmlBuf","sheetPropertiesModel","outlineProperties","tabColor","toXml","_writeSheetFormatProperties","sheetFormatPropertiesModel","_writeColumns","cols","toModel","prepare","styles","height","model","sharedStrings","hyperlinksProxy","merges","formulae","siFormulae","_hyperlinks","_writeDimensions"],"mappings":"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","file":"worksheet-writer.js","sourcesContent":["'use strict';\r\n\r\nvar _ = require('../../utils/under-dash');\r\n\r\nvar RelType = require('../../xlsx/rel-type');\r\n\r\nvar colCache = require('../../utils/col-cache');\r\nvar Dimensions = require('../../doc/range');\r\n\r\nvar StringBuf = require('../../utils/string-buf');\r\n\r\nvar Row = require('../../doc/row');\r\nvar Column = require('../../doc/column');\r\n\r\nvar SheetRelsWriter = require('./sheet-rels-writer');\r\nvar DataValidations = require('../../doc/data-validations');\r\n\r\nvar xmlBuffer = new StringBuf();\r\n\r\n// ============================================================================================\r\n// Xforms\r\nvar ListXform = require('../../xlsx/xform/list-xform');\r\nvar DataValidationsXform = require('../../xlsx/xform/sheet/data-validations-xform');\r\nvar SheetPropertiesXform = require('../../xlsx/xform/sheet/sheet-properties-xform');\r\nvar SheetFormatPropertiesXform = require('../../xlsx/xform/sheet/sheet-format-properties-xform');\r\nvar ColXform = require('../../xlsx/xform/sheet/col-xform');\r\nvar RowXform = require('../../xlsx/xform/sheet/row-xform');\r\nvar HyperlinkXform = require('../../xlsx/xform/sheet/hyperlink-xform');\r\nvar SheetViewXform = require('../../xlsx/xform/sheet/sheet-view-xform');\r\nvar PageMarginsXform = require('../../xlsx/xform/sheet/page-margins-xform');\r\nvar HeaderFooterXform = require('../../xlsx/xform/sheet/header-footer-xform');\r\nvar PageSetupXform = require('../../xlsx/xform/sheet/page-setup-xform');\r\nvar AutoFilterXform = require('../../xlsx/xform/sheet/auto-filter-xform');\r\nvar PictureXform = require('../../xlsx/xform/sheet/picture-xform');\r\n\r\n// since prepare and render is functional, we can use singletons\r\nvar xform = {\r\n  dataValidations: new DataValidationsXform(),\r\n  sheetProperties: new SheetPropertiesXform(),\r\n  sheetFormatProperties: new SheetFormatPropertiesXform(),\r\n  columns: new ListXform({tag: 'cols', length: false, childXform: new ColXform()}),\r\n  row: new RowXform(),\r\n  hyperlinks: new ListXform({tag: 'hyperlinks', length: false, childXform: new HyperlinkXform()}),\r\n  sheetViews: new ListXform({tag: 'sheetViews', length: false, childXform: new SheetViewXform()}),\r\n  pageMargins: new PageMarginsXform(),\r\n  headerFooter: new HeaderFooterXform(),\r\n  pageSeteup: new PageSetupXform(),\r\n  autoFilter: new AutoFilterXform(),\r\n  picture: new PictureXform(),\r\n};\r\n\r\n\r\n// ============================================================================================\r\n\r\nvar WorksheetWriter = module.exports = function(options) {\r\n  // in a workbook, each sheet will have a number\r\n  this.id = options.id;\r\n\r\n  // and a name\r\n  this.name = options.name || 'Sheet' + this.id;\r\n\r\n  // add a state\r\n  this.state = options.state || 'visible';\r\n\r\n  // rows are stored here while they need to be worked on.\r\n  // when they are committed, they will be deleted.\r\n  this._rows = [];\r\n\r\n  // column definitions\r\n  this._columns = null;\r\n\r\n  // column keys (addRow convenience): key ==> this._columns index\r\n  this._keys = {};\r\n\r\n  // keep record of all merges\r\n  this._merges = [];\r\n  this._merges.add = function() {}; // ignore cell instruction\r\n\r\n  // keep record of all hyperlinks\r\n  this._sheetRelsWriter = new SheetRelsWriter(options);\r\n\r\n  // keep a record of dimensions\r\n  this._dimensions = new Dimensions();\r\n\r\n  // first uncommitted row\r\n  this._rowZero = 1;\r\n\r\n  // committed flag\r\n  this.committed = false;\r\n\r\n  // for data validations\r\n  this.dataValidations = new DataValidations();\r\n\r\n  // for sharing formulae\r\n  this._formulae = {};\r\n  this._siFormulae = 0;\r\n\r\n  // for default row height, outline levels, etc\r\n  this.properties = Object.assign({}, {\r\n    defaultRowHeight: 15,\r\n    dyDescent: 55,\r\n    outlineLevelCol: 0,\r\n    outlineLevelRow: 0\r\n  }, options.properties);\r\n\r\n  // for all things printing\r\n  this.pageSetup = Object.assign({}, {\r\n    margins: {left: 0.7, right: 0.7, top: 0.75, bottom: 0.75, header: 0.3, footer: 0.3 },\r\n    orientation: 'portrait',\r\n    horizontalDpi: 4294967295,\r\n    verticalDpi: 4294967295,\r\n    fitToPage: !!(options.pageSetup && ((options.pageSetup.fitToWidth || options.pageSetup.fitToHeight) && !options.pageSetup.scale)),\r\n    pageOrder: 'downThenOver',\r\n    blackAndWhite: false,\r\n    draft: false,\r\n    cellComments: 'None',\r\n    errors: 'displayed',\r\n    scale: 100,\r\n    fitToWidth: 1,\r\n    fitToHeight: 1,\r\n    paperSize: undefined,\r\n    showRowColHeaders: false,\r\n    showGridLines: false,\r\n    horizontalCentered: false,\r\n    verticalCentered: false,\r\n    rowBreaks: null,\r\n    colBreaks: null\r\n  }, options.pageSetup);\r\n\r\n  // using shared strings creates a smaller xlsx file but may use more memory\r\n  this.useSharedStrings = options.useSharedStrings || false;\r\n\r\n  this._workbook = options.workbook;\r\n\r\n  // views\r\n  this._views = options.views || [];\r\n\r\n  // auto filter\r\n  this.autoFilter = options.autoFilter || null;\r\n\r\n  // start writing to stream now\r\n  this._writeOpenWorksheet();\r\n\r\n  // background\r\n  if (options.background && options.background.type === 'image') {\r\n    var imageName = this._workbook.addMedia(options.background);\r\n    var pictureId = this._sheetRelsWriter.addMedia({\r\n      Target: '../media/' + imageName,\r\n      Type: RelType.Image\r\n    });\r\n    this._background = {\r\n      rId: pictureId\r\n    };\r\n  }\r\n\r\n  this.startedData = false;\r\n};\r\n\r\nWorksheetWriter.prototype = {\r\n  get workbook() {\r\n    return this._workbook;\r\n  },\r\n\r\n  get stream() {\r\n    if (!this._stream) {\r\n      // eslint-disable-next-line no-underscore-dangle\r\n      this._stream = this._workbook._openStream('/xl/worksheets/sheet' + this.id + '.xml');\r\n\r\n      // pause stream to prevent 'data' events\r\n      this._stream.pause();\r\n    }\r\n    return this._stream;\r\n  },\r\n\r\n  // destroy - not a valid operation for a streaming writer\r\n  // even though some streamers might be able to, it's a bad idea.\r\n  destroy: function() {\r\n    throw new Error('Invalid Operation: destroy');\r\n  },\r\n\r\n  commit: function() {\r\n    if (this.committed) {\r\n      return;\r\n    }\r\n    // commit all rows\r\n    this._rows.forEach(cRow => {\r\n      if (cRow) {\r\n        // write the row to the stream\r\n        this._writeRow(cRow);\r\n      }\r\n    });\r\n\r\n    // we _cannot_ accept new rows from now on\r\n    this._rows = null;\r\n\r\n    if (!this.startedData) {\r\n        this._writeOpenSheetData();\r\n    }\r\n    this._writeCloseSheetData();\r\n    this._writeAutoFilter();\r\n    this._writeMergeCells();\r\n\r\n    // for some reason, Excel can't handle dimensions at the bottom of the file\r\n    // this._writeDimensions();\r\n\r\n    this._writeHyperlinks();\r\n    this._writeDataValidations();\r\n    this._writePageMargins();\r\n    this._writePageSetup();\r\n    this._writeHeaderFooter();\r\n    this._writeBackground();\r\n    this._writeCloseWorksheet();\r\n\r\n    // signal end of stream to workbook\r\n    this.stream.end();\r\n\r\n    // also commit the hyperlinks if any\r\n    this._sheetRelsWriter.commit();\r\n\r\n    this.committed = true;\r\n  },\r\n\r\n  // return the current dimensions of the writer\r\n  get dimensions() {\r\n    return this._dimensions;\r\n  },\r\n\r\n  get views() {\r\n    return this._views;\r\n  },\r\n\r\n  // =========================================================================\r\n  // Columns\r\n\r\n  // get the current columns array.\r\n  get columns() {\r\n    return this._columns;\r\n  },\r\n\r\n  // set the columns from an array of column definitions.\r\n  // Note: any headers defined will overwrite existing values.\r\n  set columns(value) {\r\n    // calculate max header row count\r\n    this._headerRowCount = value.reduce((pv, cv) => {\r\n      var headerCount =\r\n        (cv.header && 1) ||\r\n        (cv.headers && cv.headers.length) ||\r\n        0;\r\n      return Math.max(pv, headerCount);\r\n    }, 0);\r\n\r\n    // construct Column objects\r\n    var count = 1;\r\n    var columns = this._columns = [];\r\n    value.forEach(defn => {\r\n      var column = new Column(this, count++, false);\r\n      columns.push(column);\r\n      column.defn = defn;\r\n    });\r\n  },\r\n\r\n  getColumnKey(key) {\r\n    return this._keys[key];\r\n  },\r\n  setColumnKey(key, value) {\r\n    this._keys[key] = value;\r\n  },\r\n  deleteColumnKey(key) {\r\n    delete this._keys[key];\r\n  },\r\n  eachColumnKey(f) {\r\n    _.each(this._keys, f);\r\n  },\r\n\r\n  // get a single column by col number. If it doesn't exist, it and any gaps before it\r\n  // are created.\r\n  getColumn: function(c) {\r\n    if (typeof c === 'string') {\r\n      // if it matches a key'd column, return that\r\n      var col = this._keys[c];\r\n      if (col) return col;\r\n\r\n      // otherwise, assume letter\r\n      c = colCache.l2n(c);\r\n    }\r\n    if (!this._columns) { this._columns = []; }\r\n    if (c > this._columns.length) {\r\n      var n = this._columns.length + 1;\r\n      while (n <= c) {\r\n        this._columns.push(new Column(this, n++));\r\n      }\r\n    }\r\n    return this._columns[c - 1];\r\n  },\r\n\r\n  // =========================================================================\r\n  // Rows\r\n  get _nextRow() {\r\n    return this._rowZero + this._rows.length;\r\n  },\r\n\r\n  // iterate over every uncommitted row in the worksheet, including maybe empty rows\r\n  eachRow: function(options, iteratee) {\r\n    if (!iteratee) {\r\n      iteratee = options;\r\n      options = undefined;\r\n    }\r\n    if (options && options.includeEmpty) {\r\n      var n = this._nextRow;\r\n      for (var i = this._rowZero; i < n; i++) {\r\n        iteratee(this.getRow(i), i);\r\n      }\r\n    } else {\r\n      this._rows.forEach(function(row) {\r\n        if (row.hasValues) {\r\n          iteratee(row, row.number);\r\n        }\r\n      });\r\n    }\r\n  },\r\n\r\n  _commitRow: function(cRow) {\r\n    // since rows must be written in order, we commit all rows up till and including cRow\r\n    var found = false;\r\n    while (this._rows.length && !found) {\r\n      var row = this._rows.shift();\r\n      this._rowZero++;\r\n      if (row) {\r\n        this._writeRow(row);\r\n        found = (row.number === cRow.number);\r\n        this._rowZero = row.number + 1;\r\n      }\r\n    }\r\n  },\r\n\r\n  get lastRow() {\r\n    // returns last uncommitted row\r\n    if (this._rows.length) {\r\n      return this._rows[this._rows.length - 1];\r\n    }\r\n    return undefined;\r\n  },\r\n\r\n  // find a row (if exists) by row number\r\n  findRow: function(rowNumber) {\r\n    var index = rowNumber - this._rowZero;\r\n    return this._rows[index];\r\n  },\r\n\r\n  getRow: function(rowNumber) {\r\n    var index = rowNumber - this._rowZero;\r\n\r\n    // may fail if rows have been comitted\r\n    if (index < 0) {\r\n      throw new Error('Out of bounds: this row has been committed');\r\n    }\r\n    var row = this._rows[index];\r\n    if (!row) {\r\n      this._rows[index] = row = new Row(this, rowNumber);\r\n    }\r\n    return row;\r\n  },\r\n\r\n  addRow: function(value) {\r\n    var row = new Row(this, this._nextRow);\r\n    this._rows[row.number - this._rowZero] = row;\r\n    row.values = value;\r\n    return row;\r\n  },\r\n\r\n  // ================================================================================\r\n  // Cells\r\n\r\n  // returns the cell at [r,c] or address given by r. If not found, return undefined\r\n  findCell: function(r, c) {\r\n    var address = colCache.getAddress(r, c);\r\n    var row = this.findRow(address.row);\r\n    return row ? row.findCell(address.column) : undefined;\r\n  },\r\n\r\n  // return the cell at [r,c] or address given by r. If not found, create a new one.\r\n  getCell: function(r, c) {\r\n    var address = colCache.getAddress(r, c);\r\n    var row = this.getRow(address.row);\r\n    return row.getCellEx(address);\r\n  },\r\n\r\n  mergeCells: function() {\r\n    // may fail if rows have been comitted\r\n    var dimensions = new Dimensions(Array.prototype.slice.call(arguments, 0)); // convert arguments into Array\r\n\r\n    // check cells aren't already merged\r\n    this._merges.forEach(function(merge) {\r\n      if (merge.intersects(dimensions)) {\r\n        throw new Error('Cannot merge already merged cells');\r\n      }\r\n    });\r\n\r\n    // apply merge\r\n    var master = this.getCell(dimensions.top, dimensions.left);\r\n    for (var i = dimensions.top; i <= dimensions.bottom; i++) {\r\n      for (var j = dimensions.left; j <= dimensions.right; j++) {\r\n        if ((i > dimensions.top) || (j > dimensions.left)) {\r\n          this.getCell(i, j).merge(master);\r\n        }\r\n      }\r\n    }\r\n\r\n    // index merge\r\n    this._merges.push(dimensions);\r\n  },\r\n\r\n  // ================================================================================\r\n  _write: function(text) {\r\n    xmlBuffer.reset();\r\n    xmlBuffer.addText(text);\r\n    this.stream.write(xmlBuffer);\r\n  },\r\n  _writeSheetProperties: function(xmlBuf, properties, pageSetup) {\r\n    var sheetPropertiesModel = {\r\n      outlineProperties: properties && properties.outlineProperties,\r\n      tabColor: properties && properties.tabColor,\r\n      pageSetup: pageSetup && pageSetup.fitToPage ? {\r\n        fitToPage: pageSetup.fitToPage\r\n      } : undefined\r\n    };\r\n\r\n    xmlBuf.addText(xform.sheetProperties.toXml(sheetPropertiesModel));\r\n  },\r\n  _writeSheetFormatProperties: function(xmlBuf, properties) {\r\n    var sheetFormatPropertiesModel = properties ? {\r\n      defaultRowHeight: properties.defaultRowHeight,\r\n      dyDescent: properties.dyDescent,\r\n      outlineLevelCol: properties.outlineLevelCol,\r\n      outlineLevelRow: properties.outlineLevelRow\r\n    } : undefined;\r\n\r\n    xmlBuf.addText(xform.sheetFormatProperties.toXml(sheetFormatPropertiesModel));\r\n  },\r\n  _writeOpenWorksheet: function() {\r\n    xmlBuffer.reset();\r\n\r\n    xmlBuffer.addText('<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>');\r\n    xmlBuffer.addText(\r\n      '<worksheet xmlns=\"http://schemas.openxmlformats.org/spreadsheetml/2006/main\"' +\r\n      ' xmlns:r=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships\"' +\r\n      ' xmlns:mc=\"http://schemas.openxmlformats.org/markup-compatibility/2006\"' +\r\n      ' mc:Ignorable=\"x14ac\"' +\r\n      ' xmlns:x14ac=\"http://schemas.microsoft.com/office/spreadsheetml/2009/9/ac\">');\r\n\r\n    this._writeSheetProperties(xmlBuffer, this.properties, this.pageSetup);\r\n\r\n    xmlBuffer.addText(xform.sheetViews.toXml(this.views));\r\n\r\n    this._writeSheetFormatProperties(xmlBuffer, this.properties);\r\n\r\n    this.stream.write(xmlBuffer);\r\n  },\r\n  _writeColumns: function() {\r\n    var cols = Column.toModel(this.columns);\r\n    if (cols) {\r\n      xform.columns.prepare(cols, {styles: this._workbook.styles});\r\n      this.stream.write(xform.columns.toXml(cols));\r\n    }\r\n  },\r\n  _writeOpenSheetData: function() {\r\n    this._write('<sheetData>');\r\n  },\r\n  _writeRow: function(row) {\r\n    if (!this.startedData) {\r\n      this._writeColumns();\r\n      this._writeOpenSheetData();\r\n      this.startedData = true;\r\n    }\r\n\r\n    if (row.hasValues || row.height) {\r\n      var model = row.model;\r\n      var options = {\r\n        styles: this._workbook.styles,\r\n        sharedStrings: this.useSharedStrings ? this._workbook.sharedStrings : undefined,\r\n        hyperlinks: this._sheetRelsWriter.hyperlinksProxy,\r\n        merges: this._merges,\r\n        formulae: this._formulae,\r\n        siFormulae: this._siFormulae,\r\n      };\r\n      xform.row.prepare(model, options);\r\n      this.stream.write(xform.row.toXml(model));\r\n    }\r\n  },\r\n  _writeCloseSheetData: function() {\r\n    this._write('</sheetData>');\r\n  },\r\n  _writeMergeCells: function() {\r\n    if (this._merges.length) {\r\n      xmlBuffer.reset();\r\n      xmlBuffer.addText('<mergeCells count=\"' + this._merges.length + '\">');\r\n      this._merges.forEach(function(merge) {\r\n        xmlBuffer.addText('<mergeCell ref=\"' + merge + '\"/>');\r\n      });\r\n      xmlBuffer.addText('</mergeCells>');\r\n\r\n      this.stream.write(xmlBuffer);\r\n    }\r\n  },\r\n  _writeHyperlinks: function() {\r\n    // eslint-disable-next-line no-underscore-dangle\r\n    this.stream.write(xform.hyperlinks.toXml(this._sheetRelsWriter._hyperlinks));\r\n  },\r\n  _writeDataValidations: function() {\r\n    this.stream.write(xform.dataValidations.toXml(this.dataValidations.model));\r\n  },\r\n  _writePageMargins: function() {\r\n    this.stream.write(xform.pageMargins.toXml(this.pageSetup.margins));\r\n  },\r\n  _writePageSetup: function() {\r\n    this.stream.write(xform.pageSeteup.toXml(this.pageSetup));\r\n  },\r\n  _writeHeaderFooter: function() {\r\n    this.stream.write(xform.pageSeteup.toXml(this.pageSetup.headerFooter));\r\n  },\r\n  _writeAutoFilter: function() {\r\n    this.stream.write(xform.autoFilter.toXml(this.autoFilter));\r\n  },\r\n  _writeBackground: function() {\r\n    if (this._background) {\r\n      this.stream.write(xform.picture.toXml(this._background));\r\n    }\r\n  },\r\n  _writeDimensions: function() {\r\n    // for some reason, Excel can't handle dimensions at the bottom of the file\r\n    // and we don't know the dimensions until the commit, so don't write them.\r\n    // this._write('<dimension ref=\"' + this._dimensions + '\"/>');\r\n  },\r\n  _writeCloseWorksheet: function() {\r\n    this._write('</worksheet>');\r\n  }\r\n};\r\n"]}